{% extends "base.html" %}

{% block title %}CABELAB 2025 - Dashboard{% endblock %}

{% block content %}
<div class="main-container">

    {% if is_admin_view %}
    <!-- ============================================ -->
    <!-- VISTA ADMIN - Panel de Control Completo -->
    <!-- ============================================ -->
    <div class="header">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="fas fa-chart-line"></i> Panel de Control Administrativo
            </h1>
            <a href="{{ url_for('backup_db') }}" class="btn btn-primary shadow-sm">
                <i class="fas fa-download me-2"></i> Backup DB
            </a>
        </div>
        <div class="subtitle">Vista Completa del Sistema - Última actualización: {{ stats_admin.ultima_actualizacion }}
        </div>
    </div>

    <!-- ESTADÍSTICAS GLOBALES -->
    <div class="stats-container">
        <div class="stat-card total">
            <div class="stat-icon">
                <i class="fas fa-laptop-medical" style="color: #8b5cf6;"></i>
            </div>
            <div class="stat-number">{{ stats_admin.total }}</div>
            <div class="stat-label">Total Equipos</div>
        </div>

        <div class="stat-card diagnostico">
            <div class="stat-icon">
                <i class="fas fa-cog fa-spin" style="color: var(--primary);"></i>
            </div>
            <div class="stat-number">{{ stats_admin.activos }}</div>
            <div class="stat-label">Equipos Activos</div>
        </div>

        <div class="stat-card pendiente">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i>
            </div>
            <div class="stat-number">{{ stats_admin.atrasados }}</div>
            <div class="stat-label">Atrasados (+5 días)</div>
        </div>

        <div class="stat-card aprobado">
            <div class="stat-icon">
                <i class="fas fa-clock" style="color: var(--success);"></i>
            </div>
            <div class="stat-number">{{ stats_admin.tiempo_promedio }}</div>
            <div class="stat-label">Días Promedio</div>
        </div>
    </div>

    <!-- EQUIPOS CRÍTICOS -->
    {% if equipos_criticos %}
    <div class="alert alert-warning mb-4">
        <h5><i class="fas fa-exclamation-circle"></i> Equipos Críticos (más de 7 días)</h5>
        <div class="table-responsive">
            <table class="table table-sm table-dark">
                <thead>
                    <tr>
                        <th>FR</th>
                        <th>Marca/Modelo</th>
                        <th>Estado</th>
                        <th>Días</th>
                        <th>Fecha Ingreso</th>
                    </tr>
                </thead>
                <tbody>
                    {% for eq in equipos_criticos %}
                    <tr>
                        <td><span class="badge bg-danger">{{ eq.fr or 'N/A' }}</span></td>
                        <td>{{ eq.marca }} {{ eq.modelo }}</td>
                        <td><span class="badge bg-secondary">{{ eq.estado }}</span></td>
                        <td><strong>{{ (now() - eq.fecha_ingreso).days }}</strong></td>
                        <td>{{ eq.fecha_ingreso.strftime('%d/%m/%Y') if eq.fecha_ingreso else 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- TODOS LOS EQUIPOS ACTIVOS -->
    <div class="section-header">
        <div class="section-title">
            <i class="fas fa-list"></i>
            <span>Todos los Equipos Activos</span>
        </div>
        <span class="badge-count" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">{{ todos_equipos|length
            }}</span>
    </div>

    <div class="table-responsive">
        <table class="table table-dark table-hover bg-transparent align-middle" style="width:100%">
            <thead>
                <tr>
                    <th>FR</th>
                    <th>Marca/Modelo</th>
                    <th>Estado</th>
                    <th>Encargado</th>
                    <th>Fecha Ingreso</th>
                    <th>Días</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for eq in todos_equipos %}
                <tr>
                    <td><span class="fw-bold text-info">{{ eq.fr or 'N/A' }}</span></td>
                    <td>
                        <div class="fw-bold">{{ eq.marca }}</div>
                        <small class="text-muted">{{ eq.modelo }}</small>
                    </td>
                    <td>
                        <span class="badge bg-secondary">{{ eq.estado }}</span>
                    </td>
                    <td>{{ eq.encargado }}</td>
                    <td>{{ eq.fecha_ingreso.strftime('%d/%m/%Y') if eq.fecha_ingreso else '' }}</td>
                    <td>
                        {% set dias = (now() - eq.fecha_ingreso).days %}
                        <span
                            class="badge {% if dias > 7 %}bg-danger{% elif dias > 5 %}bg-warning{% else %}bg-success{% endif %}">
                            {{ dias }}
                        </span>
                    </td>
                    <td>
                        <a href="{{ url_for('panel_estados') }}" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-edit"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% else %}
    <!-- ============================================ -->
    <!-- VISTA USUARIO - Mis Tareas -->
    <!-- ============================================ -->
    <div class="header">
        <h1>
            <i class="fas fa-tasks"></i> Mis Tareas - {{ current_user.role|title }}
        </h1>
        <div class="subtitle">Equipos que requieren tu atención - Última actualización: {{
            stats_user.ultima_actualizacion }}</div>
    </div>

    <!-- ESTADÍSTICA SIMPLE -->
    <div class="stats-container">
        <div class="stat-card total" style="max-width: 300px; margin: 0 auto;">
            <div class="stat-icon">
                <i class="fas fa-clipboard-list" style="color: var(--primary);"></i>
            </div>
            <div class="stat-number">{{ stats_user.mis_tareas }}</div>
            <div class="stat-label">Tareas Pendientes</div>
        </div>
    </div>

    <!-- MIS EQUIPOS -->
    <div class="section-header">
        <div class="section-title">
            <i class="fas fa-list-check"></i>
            <span>Equipos Asignados</span>
        </div>
        <div class="d-flex gap-2">
            {% if current_user.role in [UserRoles.RECEPCION, UserRoles.ADMIN] %}
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createEquipmentModal">
                <i class="fas fa-plus-circle"></i> Registrar Nuevo Equipo
            </button>
            {% endif %}
            <a href="{{ url_for('panel_estados') }}" class="btn btn-primary">
                <i class="fas fa-tasks"></i> Gestionar Tareas
            </a>
        </div>
    </div>

    {% if equipos_relevantes %}
    <div class="row g-4">
        {% for eq in equipos_relevantes %}
        <div class="col-md-6 col-lg-4">
            <div class="card bg-dark-card border-secondary h-100 shadow-sm hover-lift">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-info">{{ eq.fr or 'Sin FR' }}</h5>
                    <span class="badge bg-secondary">{{ eq.estado }}</span>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="fw-bold text-light">{{ eq.marca }}</div>
                        <div class="text-muted small">{{ eq.modelo }}</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-user"></i> {{ eq.encargado }}
                        </small>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i> {{ eq.fecha_ingreso.strftime('%d/%m/%Y') if eq.fecha_ingreso
                            else 'N/A' }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
        <h4 class="text-light">¡Todo al día!</h4>
        <p class="text-muted">No tienes tareas pendientes en este momento</p>
    </div>
    {% endif %}

</div>

{% endif %}

<!-- MODAL REGISTRO DE EQUIPO -->
<div class="modal fade" id="createEquipmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-file-medical me-2"></i> Registrar Nuevo Equipo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="createEquipmentForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Número de FR (Opcional)</label>
                            <input type="text" name="fr" class="form-control bg-dark text-light border-secondary"
                                placeholder="Ej: 1234">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cliente <span class="text-danger">*</span></label>
                            <input type="text" name="cliente" class="form-control bg-dark text-light border-secondary"
                                required placeholder="Nombre del Cliente">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha de Ingreso</label>
                            <input type="date" name="fecha_ingreso"
                                class="form-control bg-dark text-light border-secondary">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Marca <span class="text-danger">*</span></label>
                            <input type="text" name="marca" class="form-control bg-dark text-light border-secondary"
                                required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Modelo <span class="text-danger">*</span></label>
                            <input type="text" name="modelo" class="form-control bg-dark text-light border-secondary"
                                required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Número de Serie</label>
                            <input type="text" name="serie" class="form-control bg-dark text-light border-secondary"
                                placeholder="S/N">
                        </div>
                        <!-- Removed Condition Select per User Request -->

                        <div class="col-12">
                            <label class="form-label">Accesorios</label>
                            <textarea name="accesorios" class="form-control bg-dark text-light border-secondary"
                                rows="2" placeholder="Cargador, Funda, etc."></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Reporte del Cliente <span class="text-danger">*</span></label>
                            <textarea name="reporte_cliente" class="form-control bg-dark text-light border-secondary"
                                rows="3" required></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observaciones</label>
                            <textarea name="observaciones" class="form-control bg-dark text-light border-secondary"
                                rows="2" placeholder="Notas adicionales"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-1"></i> Guardar Equipo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('createEquipmentForm');
        if (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(form);

                fetch('/api/equipment/create', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Equipo registrado correctamente');
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Ocurrió un error al registrar el equipo');
                    });
            });
        }
        // Cloud Sync Logic
        const btnSync = document.getElementById('btnSyncCloud');
        if (btnSync) {
            btnSync.addEventListener('click', function () {
                if (!confirm('¿Estás seguro de forzar la sincronización con Google Drive?\nEsto reemplazará los datos actuales.')) return;

                btnSync.disabled = true;
                btnSync.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';

                fetch('/admin/sync_excel', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            alert('¡Sincronización completada con éxito!');
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(err => alert('Error de red: ' + err))
                    .finally(() => {
                        btnSync.disabled = false;
                        btnSync.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Sincronizar Cloud';
                    });
            });
        }
    });
</script>

<style>
    .hover-lift {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3) !important;
    }

    .bg-dark-card {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 2rem 0 1rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(139, 92, 246, 0.3);
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.5rem;
        font-weight: 600;
        color: #fff;
    }

    .badge-count {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 1rem;
        font-weight: 600;
    }
</style>

{% endblock %}