{% extends "base.html" %}

{% block title %}CABELAB 2025 - Dashboard{% endblock %}

{% block content %}
<div class="main-container">

    {% if is_admin_view %}
    <!-- ============================================ -->
    <!-- VISTA ADMIN - Panel de Control Completo -->
    <!-- ============================================ -->
    <div class="header">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="fas fa-chart-line"></i> Panel de Control Administrativo
            </h1>
            <a href="{{ url_for('backup_db') }}" class="btn btn-primary shadow-sm">
                <i class="fas fa-download me-2"></i> Backup DB
            </a>
            <button id="btnSyncCloud" class="btn btn-success shadow-sm ms-2">
                <i class="fas fa-cloud-download-alt me-2"></i> Sincronizar Cloud
            </button>
        </div>
        <div class="subtitle">Vista Completa del Sistema - Última actualización: {{ stats_admin.ultima_actualizacion }}
        </div>
    </div>

    <!-- ESTADÍSTICAS GLOBALES -->
    <div class="stats-container">
        <div class="stat-card total">
            <div class="stat-icon">
                <i class="fas fa-laptop-medical" style="color: #8b5cf6;"></i>
            </div>
            <div class="stat-number">{{ stats_admin.total }}</div>
            <div class="stat-label">Total Equipos</div>
        </div>

        <div class="stat-card diagnostico">
            <div class="stat-icon">
                <i class="fas fa-cog fa-spin" style="color: var(--primary);"></i>
            </div>
            <div class="stat-number">{{ stats_admin.activos }}</div>
            <div class="stat-label">Equipos Activos</div>
        </div>

        <div class="stat-card pendiente">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i>
            </div>
            <div class="stat-number">{{ stats_admin.atrasados }}</div>
            <div class="stat-label">Atrasados (+5 días)</div>
        </div>

        <div class="stat-card aprobado">
            <div class="stat-icon">
                <i class="fas fa-clock" style="color: var(--success);"></i>
            </div>
            <div class="stat-number">{{ stats_admin.tiempo_promedio }}</div>
            <div class="stat-label">Días Promedio</div>
        </div>
    </div>

    <!-- EQUIPOS CRÍTICOS -->
    {% if equipos_criticos %}
    <div class="alert alert-warning mb-4">
        <h5><i class="fas fa-exclamation-circle"></i> Equipos Críticos (más de 7 días)</h5>
        <div class="table-responsive">
            <table class="table table-sm table-dark">
                <thead>
                    <tr>
                        <th>FR</th>
                        <th>Marca/Modelo</th>
                        <th>Estado</th>
                        <th>Días</th>
                        <th>Fecha Ingreso</th>
                    </tr>
                </thead>
                <tbody>
                    {% for eq in equipos_criticos %}
                    <tr>
                        <td><span class="badge bg-danger">{{ eq.fr or 'N/A' }}</span></td>
                        <td>{{ eq.marca }} {{ eq.modelo }}</td>
                        <td><span class="badge bg-secondary">{{ eq.estado }}</span></td>
                        <td><strong>{{ (now() - eq.fecha_ingreso).days }}</strong></td>
                        <td>{{ eq.fecha_ingreso.strftime('%d/%m/%Y') if eq.fecha_ingreso else 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- TODOS LOS EQUIPOS ACTIVOS -->
    <div class="section-header">
        <div class="section-title">
            <i class="fas fa-list"></i>
            <span>Todos los Equipos Activos</span>
        </div>
        <span class="badge-count" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">{{ todos_equipos|length
            }}</span>
    </div>

    <div class="table-responsive">
        <table class="table table-dark table-hover bg-transparent align-middle" style="width:100%">
            <thead>
                <tr>
                    <th>FR</th>
                    <th>Marca/Modelo</th>
                    <th>Estado</th>
                    <th>Encargado</th>
                    <th>Fecha Ingreso</th>
                    <th>Días</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for eq in todos_equipos %}
                <tr>
                    <td><span class="fw-bold text-info">{{ eq.fr or 'N/A' }}</span></td>
                    <td>
                        <div class="fw-bold">{{ eq.marca }}</div>
                        <small class="text-muted">{{ eq.modelo }}</small>
                    </td>
                    <td>
                        <span class="badge bg-secondary">{{ eq.estado }}</span>
                    </td>
                    <td>{{ eq.encargado }}</td>
                    <td>{{ eq.fecha_ingreso.strftime('%d/%m/%Y') if eq.fecha_ingreso else '' }}</td>
                    <td>
                        {% set dias = (now() - eq.fecha_ingreso).days %}
                        <span
                            class="badge {% if dias > 7 %}bg-danger{% elif dias > 5 %}bg-warning{% else %}bg-success{% endif %}">
                            {{ dias }}
                        </span>
                    </td>
                    <td>
                        <a href="{{ url_for('panel_estados') }}" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-edit"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% else %}
    <!-- ============================================ -->
    <!-- VISTA USUARIO - Mis Tareas -->
    <!-- ============================================ -->
    <div class="header">
        <h1>
            <i class="fas fa-tasks"></i> Mis Tareas - {{ current_user.role|title }}
        </h1>
        <div class="subtitle">Equipos que requieren tu atención - Última actualización: {{
            stats_user.ultima_actualizacion }}</div>
    </div>

    <!-- ESTADÍSTICA SIMPLE -->
    <!-- ============================================ -->
    <!-- NUEVA VISTA DE RESUMEN Y TABLAS -->
    <!-- ============================================ -->

    <!-- 1. STATUS SUMMARY (BADGES) -->
    <div class="row mb-4">
        {% for status, count in stats_user.counts.items() %}
        {% if count > 0 %}
        <div class="col-auto">
            <span class="badge rounded-pill bg-dark border border-secondary p-2 px-3">
                <span class="text-uppercase text-light small">{{ status }}</span>
                <span class="badge bg-primary ms-2">{{ count }}</span>
            </span>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- 2. SECTION PRIORITARIA RECEPCION (Recientes vs Veteranos) -->
    {% if current_user.role|lower == UserRoles.RECEPCION|lower and (recent_pending or veteran_pending) %}
    <div class="row g-4 mb-5">
        <div class="col-md-6">
            <div class="card bg-dark bg-opacity-50 border-danger h-100">
                <div class="card-header border-danger text-danger fw-bold">
                    <i class="fas fa-hourglass-end me-2"></i> PENDIENTES MÁS ANTIGUOS
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for eq in veteran_pending %}
                        <li
                            class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-danger me-2">{{ eq.fr }}</span>
                                <small>{{ eq.marca }} {{ eq.modelo }}</small>
                            </div>
                            <small class="text-muted">
                                {{ eq.fecha_ingreso.strftime('%d/%m') if eq.fecha_ingreso else 'N/A' }}
                            </small>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-dark bg-opacity-50 border-success h-100">
                <div class="card-header border-success text-success fw-bold">
                    <i class="fas fa-star me-2"></i> RECIÉN LLEGADOS APROBACIÓN
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for eq in recent_pending %}
                        <li
                            class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-success me-2">{{ eq.fr }}</span>
                                <small>{{ eq.marca }} {{ eq.modelo }}</small>
                            </div>
                            <small class="text-muted">
                                {{ eq.fecha_ingreso.strftime('%d/%m') if eq.fecha_ingreso else 'N/A' }}
                            </small>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 3. MAIN TABLE (REPLACES CARDS) -->
    <div class="card bg-dark border-secondary shadow-lg">
        <div class="card-header border-secondary">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i> Gestionar Tareas ({{ stats_user.mis_tareas }})</h5>
            <div class="d-flex gap-2">
                {% if current_user.role in [UserRoles.RECEPCION, UserRoles.ADMIN] %}
                <!-- Button moved inside header for table layout -->
                <button class="btn btn-sm btn-success ms-auto" data-bs-toggle="modal"
                    data-bs-target="#createEquipmentModal">
                    <i class="fas fa-plus-circle"></i> Nuevo Equipo
                </button>
                {% endif %}
                <a href="{{ url_for('panel_estados') }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-expand"></i> Pantalla Completa
                </a>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0">
                <thead>
                    <tr>
                        <th>FR</th>
                        {% if current_user.role|lower == UserRoles.RECEPCION|lower %}
                        <th>Cliente</th>
                        {% endif %}
                        <th>Equipo</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                        {% if current_user.role|lower != UserRoles.RECEPCION|lower %}
                        <th>Encargado</th>
                        {% endif %}
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for eq in equipos_relevantes %}
                    <tr>
                        <td><span class="badge bg-secondary">{{ eq.fr or 'N/A' }}</span></td>

                        {% if current_user.role|lower == UserRoles.RECEPCION|lower %}
                        <td class="text-info small">{{ eq.cliente or 'No asignado' }}</td>
                        {% endif %}

                        <td>
                            <div class="fw-bold">{{ eq.marca }}</div>
                            <div class="small text-muted">{{ eq.modelo }}</div>
                            {% if current_user.role|lower == UserRoles.OPERACIONES|lower %}
                            <div class="small text-warning fst-italic">{{ eq.condicion }}</div>
                            {% endif %}
                        </td>

                        <td>
                            <span class="badge bg-dark border border-secondary text-uppercase"
                                style="font-size: 0.75rem;">
                                {{ eq.estado }}
                            </span>
                        </td>

                        <td>
                            <small class="text-muted">{{ eq.fecha_ingreso.strftime('%d/%m/%Y') if eq.fecha_ingreso else
                                '' }}</small>
                        </td>

                        {% if current_user.role|lower != UserRoles.RECEPCION|lower %}
                        <td>
                            <small>{{ eq.encargado }}</small>
                        </td>
                        {% endif %}

                        <td>
                            <div class="d-flex gap-1">
                                {% if current_user.role|lower == UserRoles.RECEPCION|lower and 'pendiente' in
                                eq.estado|default('')|lower %}
                                <button class="btn btn-sm btn-success" onclick="updateStatus({{ eq.id }}, 'Aprobado')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="updateStatus({{ eq.id }}, 'Rechazado')">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                                <a href="{{ url_for('panel_estados') }}" class="btn btn-sm btn-outline-primary"
                                    title="Ver en Panel Completo">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            <i class="fas fa-check-circle fa-2x mb-2"></i><br>
                            Sin tareas pendientes
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>



</div>

{% endif %}

<!-- MODAL REGISTRO DE EQUIPO -->
<div class="modal fade" id="createEquipmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-file-medical me-2"></i> Registrar Nuevo Equipo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="createEquipmentForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Número de FR (Opcional)</label>
                            <input type="text" name="fr" class="form-control bg-dark text-light border-secondary"
                                placeholder="Ej: 1234">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cliente <span class="text-danger">*</span></label>
                            <input type="text" name="cliente" class="form-control bg-dark text-light border-secondary"
                                required placeholder="Nombre del Cliente">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha de Ingreso</label>
                            <input type="date" name="fecha_ingreso"
                                class="form-control bg-dark text-light border-secondary">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Marca <span class="text-danger">*</span></label>
                            <input type="text" name="marca" class="form-control bg-dark text-light border-secondary"
                                required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Modelo <span class="text-danger">*</span></label>
                            <input type="text" name="modelo" class="form-control bg-dark text-light border-secondary"
                                required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Número de Serie</label>
                            <input type="text" name="serie" class="form-control bg-dark text-light border-secondary"
                                placeholder="S/N">
                        </div>
                        <!-- Removed Condition Select per User Request -->

                        <div class="col-12">
                            <label class="form-label">Accesorios</label>
                            <textarea name="accesorios" class="form-control bg-dark text-light border-secondary"
                                rows="2" placeholder="Cargador, Funda, etc."></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Reporte del Cliente <span class="text-danger">*</span></label>
                            <textarea name="reporte_cliente" class="form-control bg-dark text-light border-secondary"
                                rows="3" required></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observaciones</label>
                            <textarea name="observaciones" class="form-control bg-dark text-light border-secondary"
                                rows="2" placeholder="Notas adicionales"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-1"></i> Guardar Equipo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('createEquipmentForm');
        if (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(form);

                fetch('/api/equipment/create', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Equipo registrado correctamente');
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Ocurrió un error al registrar el equipo');
                    });
            });
        }
        // Cloud Sync Logic
        const btnSync = document.getElementById('btnSyncCloud');
        if (btnSync) {
            btnSync.addEventListener('click', function () {
                if (!confirm('¿Estás seguro de forzar la sincronización con Google Drive?\nEsto reemplazará los datos actuales.')) return;

                btnSync.disabled = true;
                btnSync.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';

                fetch('/admin/sync_excel', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            alert('¡Sincronización completada con éxito!');
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(err => alert('Error de red: ' + err))
                    .finally(() => {
                        btnSync.disabled = false;
                        btnSync.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Sincronizar Cloud';
                    });
            });
        }
    });
</script>

<style>
    .hover-lift {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3) !important;
    }

    .bg-dark-card {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 2rem 0 1rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(139, 92, 246, 0.3);
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.5rem;
        font-weight: 600;
        color: #fff;
    }

    .badge-count {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 1rem;
        font-weight: 600;
    }
</style>

<script>
    // Global Action for Dashboard Buttons
    window.updateStatus = function (id, newStatus, newEncargado = null) {
        let msg = `¿Cambiar estado a: ${newStatus}?`;
        if (newEncargado) msg += `\nAsignando a: ${newEncargado}`;

        if (!confirm(msg)) return;

        const formData = new FormData();
        formData.append('status', newStatus);
        if (newEncargado) formData.append('encargado', newEncargado);

        fetch(`/api/equipment/${id}/update_status`, { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                if (data.success) location.reload();
                else alert('Error: ' + data.error);
            })
            .catch(err => alert('Error de red: ' + err));
    };
</script>

{% endblock %}