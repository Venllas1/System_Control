{% extends "base.html" %}

{% block title %}Panel General de Gestión - CABELAB{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-white mb-0"><i class="fas fa-table me-2"></i> Panel General de Gestión</h2>
            <p class="text-muted mb-0">Vista administrativa completa de todos los equipos</p>
        </div>
        <div class="d-flex gap-2">
            <div class="input-group">
                <span class="input-group-text bg-dark border-secondary text-secondary">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="generalSearch" class="form-control bg-dark text-light border-secondary"
                    placeholder="Buscar en todo...">
            </div>
            <button class="btn btn-outline-info" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Main Table Card -->
    <div class="card bg-dark-card border-secondary shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0 align-middle" id="generalTable">
                    <thead class="bg-dark text-secondary text-uppercase text-xs sticky-top">
                        <tr>
                            <th class="ps-4">ID</th>
                            <th>FR</th>
                            <th>Equipo</th>
                            <th>Estado</th>
                            <th>Cliente</th>
                            <th>Encargado</th>
                            <th>Fecha Ingreso</th>
                            <th class="text-end pe-4">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="generalTableBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer border-secondary py-2">
            <small class="text-muted" id="recordCount">Cargando...</small>
        </div>
    </div>
</div>

<!-- DATA CONTAINER -->
<div id="allEquipmentsData" data-url="{{ url_for('api.search') }}?q=%" style="display:none;"></div>

<!-- EDIT MODAL (Simplified for Data Only) -->
<div class="modal fade" id="editDataModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark-card border-secondary text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-edit text-info me-2"></i>Editar Datos del Equipo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editDataForm">
                    <input type="hidden" name="id" id="editId">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label text-secondary">FR</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" name="fr"
                                id="editFr">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-secondary">Marca</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" name="marca"
                                id="editMarca">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-secondary">Modelo</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" name="modelo"
                                id="editModelo">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Cliente</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" name="cliente"
                                id="editCliente">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Encargado</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" name="encargado"
                                id="editEncargado">
                        </div>
                        <div class="col-12">
                            <label class="form-label text-secondary">Observaciones</label>
                            <textarea class="form-control bg-dark text-light border-secondary" name="observaciones"
                                id="editObservaciones" rows="3"></textarea>
                        </div>
                        <div class="col-12">
                            <div class="alert alert-info border-info bg-opacity-10 d-flex align-items-center">
                                <i class="fas fa-info-circle me-2"></i>
                                <small>El estado del equipo solo puede cambiarse a través del Panel de Estados siguiendo
                                    el flujo de trabajo.</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveEquipmentData()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        await loadAllEquipment();

        // Search Filter
        document.getElementById('generalSearch').addEventListener('keyup', function (e) {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#generalTableBody tr');

            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        });
    });

    async function loadAllEquipment() {
        try {
            // Using search endpoint with empty query to get everything if supported, 
            // otherwise we might need a dedicated endpoint. 
            // For now, let's try the existing search with a wildcard or similar if supported,
            // OR use the export logic jsonified. 
            // Actually, let's use the search endpoint with a generic char or update API to support 'all'.
            // The plan mentioned creating new views, but we can reuse search API if updated or creating a new one.
            // Let's assume we use a new endpoint or update search. 
            // For now, I'll use the search endpoint with a special param if possible, or just fetch from a new endpoint if I created one.
            // Wait, I didn't create a 'get all' endpoint yet. I should add that or use existing.
            // Let's use the /api/export/json endpoint logic but properly returned.
            // Actually, let's just use the search endpoint, modifying it to return all if query is empty/special.

            // Re-using search with a space might work if implemented.
            const response = await fetch('/api/search?q=%20');
            const result = await response.json();

            if (result.success) {
                renderTable(result.data);
            } else {
                console.error('Error loading data');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('generalTableBody');
        const count = document.getElementById('recordCount');

        tbody.innerHTML = data.map(item => `
            <tr>
                <td class="ps-4 text-muted">#${item.id}</td>
                <td class="text-info fw-bold">${item.fr || '-'}</td>
                <td>
                    <div class="d-flex flex-column">
                        <span class="fw-bold text-white">${item.marca}</span>
                        <small class="text-muted">${item.modelo}</small>
                    </div>
                </td>
                <td><span class="badge bg-secondary">${item.estado}</span></td>
                <td>${item.cliente || '-'}</td>
                <td>${item.encargado || '-'}</td>
                <td>${item.fecha_ingreso || '-'}</td>
                <td class="text-end pe-4">
                    <button class="btn btn-sm btn-outline-warning" onclick='openEditModal(${JSON.stringify(item).replace(/'/g, "&#39;")})'>
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `).join('');

        count.innerText = `${data.length} registros encontrados`;
    }

    window.openEditModal = function (item) {
        document.getElementById('editId').value = item.id;
        document.getElementById('editFr').value = item.fr || '';
        document.getElementById('editMarca').value = item.marca || '';
        document.getElementById('editModelo').value = item.modelo || '';
        document.getElementById('editCliente').value = item.cliente || '';
        document.getElementById('editEncargado').value = item.encargado || '';
        document.getElementById('editObservaciones').value = item.observaciones || '';

        new bootstrap.Modal(document.getElementById('editDataModal')).show();
    }

    window.saveEquipmentData = async function () {
        const id = document.getElementById('editId').value;
        const form = document.getElementById('editDataForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch(`/api/equipment/${id}/update_data`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                alert('Datos actualizados');
                location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            alert('Error al guardar');
        }
    }
</script>
{% endblock %}