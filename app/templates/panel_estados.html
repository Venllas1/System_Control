{% extends "base.html" %}
{% block title %}Gestión de Estados - CABELAB{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="header mb-4">
        <div class="d-flex align-items-center">
            <i class="fas fa-clipboard-list me-3" style="font-size: 2rem; color: var(--primary);"></i>
            <div>
                <h1 class="mb-0">Gestión de Estados</h1>
                <p class="subtitle mb-0">Panel de Control: {{ current_user.role|title }}</p>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-container mb-4">
        <!-- Diagnóstico Card -->
        <div class="stat-card diagnostico">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-icon">
                        <i class="fas fa-stethoscope"></i>
                    </div>
                    <div class="stat-label mt-2">EN DIAGNÓSTICO</div>
                    <div class="stat-number">{{ stats.diagnostico or 0 }}</div>
                </div>
            </div>
        </div>

        <!-- Aprobados Card -->
        <div class="stat-card aprobado">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-label mt-2">APROBADOS</div>
                    <div class="stat-number">{{ stats.aprobados or 0 }}</div>
                </div>
            </div>
        </div>

        <!-- Pendientes Card -->
        <div class="stat-card pendiente">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-label mt-2">PENDIENTES DE APROBACIÓN</div>
                    <div class="stat-number">{{ stats.pendientes or 0 }}</div>
                </div>
            </div>
        </div>

        <!-- Total Card -->
        <div class="stat-card total">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stat-label mt-2">TOTAL EQUIPOS</div>
                    <div class="stat-number">{{ stats.total or 0 }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Diagnóstico Section -->
    <div class="section-container mb-4">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#diagnosticoSection"
            style="cursor: pointer;">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="fas fa-stethoscope me-2" style="color: var(--info);"></i>
                    <span class="section-title">Diagnóstico</span>
                </div>
                <i class="fas fa-chevron-down"></i>
            </div>
        </div>
        <div class="collapse show" id="diagnosticoSection">
            <div class="table-responsive mt-3">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>FR</th>
                            <th>MARCA/MODELO</th>
                            <th>ESTADO</th>
                            <th>ENCARGADO</th>
                            <th>FECHA</th>
                            <th>DÍAS</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if diagnostico_equipos %}
                        {% for eq in diagnostico_equipos %}
                        <tr>
                            <td>{{ eq.fr }}</td>
                            <td>{{ eq.marca_modelo }}</td>
                            <td><span class="badge" style="background: var(--info);">Sin resultados</span></td>
                            <td>{{ eq.encargado or '-' }}</td>
                            <td>{{ eq.fecha_ingreso.strftime('%Y-%m-%d') if eq.fecha_ingreso else '-' }}</td>
                            <td>{{ ((now() - eq.fecha_ingreso).days if eq.fecha_ingreso else '-') }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">Sin resultados</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Aprobados / En Servicio Section -->
    <div class="section-container mb-4">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#aprobadosSection"
            style="cursor: pointer;">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-2" style="color: var(--success);"></i>
                    <span class="section-title">Aprobados / En Servicio</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-muted small">{{ aprobados_equipos|length if aprobados_equipos else 0 }} / {{
                        servicio_equipos|length if servicio_equipos else 0 }}</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </div>
        <div class="collapse show" id="aprobadosSection">
            <div class="table-responsive mt-3">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>FR</th>
                            <th>MARCA/MODELO</th>
                            <th>ESTADO</th>
                            <th>ENCARGADO</th>
                            <th>FECHA</th>
                            <th>DÍAS</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if aprobados_equipos %}
                        {% for eq in aprobados_equipos %}
                        <tr>
                            <td>{{ eq.fr }}</td>
                            <td>{{ eq.marca_modelo }}</td>
                            <td>
                                {% if eq.estado == 'Aprobado' %}
                                <span class="badge" style="background: var(--primary);">✓ aprobó servicio</span>
                                {% elif eq.estado == 'En Servicio' %}
                                <span class="badge" style="background: var(--info);">⚙ en servicio</span>
                                {% endif %}
                            </td>
                            <td>{{ eq.encargado or '-' }}</td>
                            <td>{{ eq.fecha_ingreso.strftime('%Y-%m-%d') if eq.fecha_ingreso else '-' }}</td>
                            <td>{{ ((now() - eq.fecha_ingreso).days if eq.fecha_ingreso else '-') }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="showDetails({{ eq.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                        {% if servicio_equipos %}
                        {% for eq in servicio_equipos %}
                        <tr>
                            <td>{{ eq.fr }}</td>
                            <td>{{ eq.marca_modelo }}</td>
                            <td><span class="badge" style="background: var(--info);">⚙ en servicio</span></td>
                            <td>{{ eq.encargado or '-' }}</td>
                            <td>{{ eq.fecha_ingreso.strftime('%Y-%m-%d') if eq.fecha_ingreso else '-' }}</td>
                            <td>{{ ((now() - eq.fecha_ingreso).days if eq.fecha_ingreso else '-') }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="showDetails({{ eq.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                        {% if not aprobados_equipos and not servicio_equipos %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">Sin resultados</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Reevaluaciones o Revisión Section -->
    <div class="section-container mb-4">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#reevaluacionSection"
            style="cursor: pointer;">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="fas fa-redo me-2" style="color: var(--primary);"></i>
                    <span class="section-title">Reevaluaciones o Revisión</span>
                </div>
                <i class="fas fa-chevron-down"></i>
            </div>
        </div>
        <div class="collapse" id="reevaluacionSection">
            <div class="table-responsive mt-3">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>FR</th>
                            <th>MARCA/MODELO</th>
                            <th>ESTADO</th>
                            <th>ENCARGADO</th>
                            <th>FECHA</th>
                            <th>DÍAS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="text-center text-muted">Sin resultados</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pendiente Aprobación Section -->
    <div class="section-container mb-4">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#pendienteSection"
            style="cursor: pointer;">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="fas fa-clock me-2" style="color: var(--warning);"></i>
                    <span class="section-title">Pendiente Aprobación</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-muted small">{{ pendientes_equipos|length if pendientes_equipos else 0 }}</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </div>
        <div class="collapse show" id="pendienteSection">
            <div class="table-responsive mt-3">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>FR</th>
                            <th>MARCA/MODELO</th>
                            <th>ESTADO</th>
                            <th>ENCARGADO DEL DIAGNÓSTICO</th>
                            <th>FECHA</th>
                            <th>DÍAS</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if pendientes_equipos %}
                        {% for eq in pendientes_equipos %}
                        <tr>
                            <td>{{ eq.fr }}</td>
                            <td>{{ eq.marca_modelo }}</td>
                            <td><span class="badge" style="background: var(--warning);">⏳ PENDIENTE DE APROBACIÓN</span>
                            </td>
                            <td>{{ eq.encargado or 'GERSSON' }}</td>
                            <td>{{ eq.fecha_ingreso.strftime('%Y-%m-%d') if eq.fecha_ingreso else '-' }}</td>
                            <td>{{ ((now() - eq.fecha_ingreso).days if eq.fecha_ingreso else '-') }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="showDetails({{ eq.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">Sin resultados</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .section-container {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.5rem;
    }

    .section-header {
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--glass-border);
        transition: all 0.3s;
    }

    .section-header:hover {
        color: var(--primary);
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-main);
    }

    .stat-icon {
        font-size: 2rem;
    }
</style>

<script>
    function showDetails(equipmentId) {
        // Implementar modal de detalles
        console.log('Showing details for equipment:', equipmentId);
    }
</script>
{% endblock %}