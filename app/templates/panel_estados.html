{% extends "base.html" %}
{% block title %}Gesti√≥n de Estados - CABELAB{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-white mb-0"><i class="fas fa-tasks me-2"></i> Gesti√≥n de Estados</h2>
            <p class="text-muted mb-0">Panel de Control: {{ current_role|title }}</p>
        </div>

        <div class="d-flex gap-2">
            {% if current_role != 'visualizador' %}
            <div class="input-group">
                <span class="input-group-text bg-dark border-secondary text-secondary">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="searchInput" class="form-control bg-dark text-light border-secondary"
                    placeholder="Buscar equipo...">
            </div>
            {% endif %}
            <!-- Excel Sync Disabled (Native DB Mode)
            <button class="btn btn-outline-light refresh-btn" title="Refrescar Datos">
                <i class="fas fa-sync-alt"></i>
            </button>
            -->
            <!-- Export Button is enough -->
            <div class="ms-2">
                {% if current_role == 'visualizador' or current_role == 'admin' %}
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createEquipmentModal">
                    <i class="fas fa-plus me-1"></i> Agregar Equipo
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    {% if current_role == 'visualizador' or current_role == 'admin' %}
    <!-- KPI SUMMARY CARDS -->
    <div class="row g-4 mb-4">
        <!-- 1. En Diagn√≥stico -->
        <div class="col-xl-3 col-sm-6">
            <div class="card bg-dark-card border-secondary shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon icon-shape bg-info shadow text-center border-radius-md">
                            <i class="fas fa-stethoscope text-white opacity-10"></i>
                        </div>
                        <div class="ms-3">
                            <p class="text-xs font-weight-bold mb-0 text-info text-uppercase">En Diagn√≥stico</p>
                            <h4 class="font-weight-bolder text-white mb-0" id="kpiDiag">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 2. Aprobados -->
        <div class="col-xl-3 col-sm-6">
            <div class="card bg-dark-card border-secondary shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon icon-shape bg-success shadow text-center border-radius-md">
                            <i class="fas fa-check-circle text-white opacity-10"></i>
                        </div>
                        <div class="ms-3">
                            <p class="text-xs font-weight-bold mb-0 text-success text-uppercase">Aprobados</p>
                            <h4 class="font-weight-bolder text-white mb-0" id="kpiApro">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 3. Pendientes de Aprobaci√≥n -->
        <div class="col-xl-3 col-sm-6">
            <div class="card bg-dark-card border-secondary shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon icon-shape bg-warning shadow text-center border-radius-md">
                            <i class="fas fa-clock text-white opacity-10"></i>
                        </div>
                        <div class="ms-3">
                            <p class="text-xs font-weight-bold mb-0 text-warning text-uppercase">Pendientes de
                                Aprobaci√≥n</p>
                            <h4 class="font-weight-bolder text-white mb-0" id="kpiPend">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 4. Total Equipos -->
        <div class="col-xl-3 col-sm-6">
            <div class="card bg-dark-card border-secondary shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon icon-shape bg-primary shadow text-center border-radius-md">
                            <i class="fas fa-cubes text-white opacity-10"></i>
                        </div>
                        <div class="ms-3">
                            <p class="text-xs font-weight-bold mb-0 text-secondary text-uppercase">Total Equipos</p>
                            <h4 class="font-weight-bolder text-white mb-0" id="kpiTotal">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA VISUALIZADOR (3 TABLAS + FILTROS INDEPENDIENTES) -->
    <!-- ORDER: 1. Diagnostico, 2. Pendiente, 3. Revision -->
    <div class="row g-4">

        <!-- 1. DIAGNOSTICO -->
        <div class="col-12">
            <div class="card bg-dark-card border-secondary shadow-sm">
                <div
                    class="card-header border-secondary d-flex justify-content-between align-items-center bg-info bg-opacity-10">
                    <h5 class="mb-0 text-info"><i class="fas fa-stethoscope me-2"></i> Diagn√≥stico</h5>
                    <div class="input-group input-group-sm w-25">
                        <input type="text" id="searchDiagnostico"
                            class="form-control bg-dark text-light border-secondary" placeholder="Filtrar...">
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0 align-middle">
                            <thead>
                                <tr class="text-secondary text-uppercase text-xs">
                                    <th class="ps-4">FR</th>
                                    <th>Marca/Modelo</th>
                                    <th>Estado</th>
                                    <th>Encargado</th>
                                    <th>Fecha</th>
                                    <th class="text-center">D√≠as</th>
                                    <th class="text-end pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tableDiagnostico"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. APROBADOS (Visible now, excluding Entregados) -->
        <div class="col-12">
            <div class="card bg-dark-card border-secondary shadow-sm">
                <div
                    class="card-header border-secondary d-flex justify-content-between align-items-center bg-success bg-opacity-10">
                    <h5 class="mb-0 text-success"><i class="fas fa-check-circle me-2"></i> Aprobados / En Servicio</h5>
                    <div class="d-flex align-items-center gap-2">
                        <div class="input-group input-group-sm" style="width: 200px;">
                            <input type="text" id="searchAprobado"
                                class="form-control bg-dark text-light border-secondary" placeholder="Filtrar...">
                        </div>
                        <!-- Pagination Controls -->
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" id="btnPrevAprobado" disabled><i
                                    class="fas fa-chevron-left"></i></button>
                            <span class="btn btn-outline-secondary disabled text-light border-secondary"
                                id="pageInfoAprobado">1/1</span>
                            <button class="btn btn-outline-secondary" id="btnNextAprobado" disabled><i
                                    class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0 align-middle">
                            <thead>
                                <tr class="text-secondary text-uppercase text-xs">
                                    <th class="ps-4">FR</th>
                                    <th>Marca/Modelo</th>
                                    <th>Estado</th>
                                    <th>Encargado</th>
                                    <th>Fecha</th>
                                    <th class="text-center">D√≠as</th>
                                    <th class="text-end pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tableAprobado"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. REEVALUACIONES O REVISION -->
        <div class="col-12">
            <div class="card bg-dark-card border-secondary shadow-sm">
                <div
                    class="card-header border-secondary d-flex justify-content-between align-items-center bg-primary bg-opacity-10">
                    <h5 class="mb-0 text-primary"><i class="fas fa-sync-alt me-2"></i> Reevaluaciones o Revisi√≥n</h5>
                    <div class="input-group input-group-sm w-25">
                        <input type="text" id="searchRevision" class="form-control bg-dark text-light border-secondary"
                            placeholder="Filtrar...">
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0 align-middle">
                            <thead>
                                <tr class="text-secondary text-uppercase text-xs">
                                    <th class="ps-4">FR</th>
                                    <th>Marca/Modelo</th>
                                    <th>Estado</th>
                                    <th>Encargado</th>
                                    <th>Fecha</th>
                                    <th class="text-center">D√≠as</th>
                                    <th class="text-end pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tableRevision"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. PENDIENTE APROBACION (PAGINATED) -->
        <div class="col-12">
            <div class="card bg-dark-card border-secondary shadow-sm">
                <div
                    class="card-header border-secondary d-flex justify-content-between align-items-center bg-warning bg-opacity-10">
                    <h5 class="mb-0 text-warning"><i class="fas fa-clock me-2"></i> Pendiente Aprobaci√≥n</h5>
                    <div class="d-flex align-items-center gap-2">
                        <div class="input-group input-group-sm" style="width: 200px;">
                            <input type="text" id="searchPendiente"
                                class="form-control bg-dark text-light border-secondary" placeholder="Filtrar...">
                        </div>
                        <!-- Pagination Controls -->
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" id="btnPrevPendiente" disabled><i
                                    class="fas fa-chevron-left"></i></button>
                            <span class="btn btn-outline-secondary disabled text-light border-secondary"
                                id="pageInfoPendiente">1/1</span>
                            <button class="btn btn-outline-secondary" id="btnNextPendiente" disabled><i
                                    class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0 align-middle">
                            <thead>
                                <tr class="text-secondary text-uppercase text-xs">
                                    <th class="ps-4">FR</th>
                                    <th>Marca/Modelo</th>
                                    <th>Estado</th>
                                    <!-- RENAMED COLUMN PER USER REQUEST -->
                                    <th>ENCARGADO DEL DIAGNOSTICO</th>
                                    <th>Fecha</th>
                                    <th class="text-center">D√≠as</th>
                                    <th class="text-end pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablePendiente"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    {% else %}
    <!-- VISTA OPERATIVA (REORGANIZADA COMO VISUALIZADOR) -->
    <div id="operationalView" class="row g-4">

        <!-- ========== TAREAS PENDIENTES (PRIORITY SECTION) ========== -->
        <div class="col-12" id="pendingTasksContainer">
            <div class="card bg-gradient-dark border-warning shadow-lg">
                <div class="card-header border-warning bg-warning bg-opacity-20">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 text-warning fw-bold">
                            <i class="fas fa-clipboard-list me-2"></i> üìã Tareas Pendientes
                        </h4>
                        <div class="d-flex align-items-center gap-2">
                            <span id="pendingTasksCount" class="badge bg-warning text-dark">0 tareas</span>
                            <button class="btn btn-sm btn-outline-warning" id="refreshPendingTasks" title="Actualizar">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="alert alert-warning border-0 rounded-0 mb-0 py-2 px-4" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <small><strong>Equipos que requieren tu atenci√≥n inmediata</strong> - Ordenados por antig√ºedad
                            (m√°s antiguos primero)</small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0 align-middle">
                            <thead class="text-secondary text-uppercase text-xs">
                                <tr>
                                    <th class="ps-4">FR</th>
                                    <th>Marca/Modelo</th>
                                    <th>Estado</th>
                                    <th>Encargado</th>
                                    <th>Fecha Ingreso</th>
                                    <th class="text-center">D√≠as</th>
                                    <th class="text-end pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="pendingTasksTable">
                                <!-- Populated by workflow.js -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- ========== END TAREAS PENDIENTES ========== -->

        <!-- RECEPCI√ìN: Pendientes de Aprobaci√≥n, Servicio Culminado -->
        <div class="col-12" id="cardPendientesOp">
            <div class="card bg-dark-card border-secondary shadow-sm">
                <div
                    class="card-header border-secondary d-flex justify-content-between align-items-center bg-warning bg-opacity-10">
                    <h5 class="mb-0 text-warning fw-bold"><i class="fas fa-clock me-2"></i> Pendientes de Aprobaci√≥n
                    </h5>
                    <div class="d-flex align-items-center gap-2">
                        <div class="input-group input-group-sm" style="width: 200px;">
                            <input type="text" id="searchPendientesOp"
                                class="form-control bg-dark text-light border-secondary" placeholder="Filtrar...">
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" id="btnPrevPendientesOp" disabled><i
                                    class="fas fa-chevron-left"></i></button>
                            <span class="btn btn-outline-secondary disabled text-light border-secondary"
                                id="pageInfoPendientesOp">1/1</span>
                            <button class="btn btn-outline-secondary" id="btnNextPendientesOp" disabled><i
                                    class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0 align-middle">
                            <thead class="text-secondary text-uppercase text-xs">
                                <tr>
                                    <th class="ps-4">FR</th>
                                    <th>Marca/Modelo</th>
                                    <th>Estado</th>
                                    <th>Encargado</th>
                                    <th>Fecha</th>
                                    <th class="text-center">D√≠as</th>
                                    <th class="text-end pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablePendientesOp"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- OPERACIONES: En Diagn√≥stico -->
        <div class="col-12" id="cardDiagnosticoOp">
            <div class="card bg-dark-card border-secondary shadow-sm">
                <div
                    class="card-header border-secondary d-flex justify-content-between align-items-center bg-info bg-opacity-10">
                    <h5 class="mb-0 text-info fw-bold"><i class="fas fa-microscope me-2"></i> En Diagn√≥stico</h5>
                    <div class="input-group input-group-sm w-25">
                        <input type="text" id="searchDiagnosticoOp"
                            class="form-control bg-dark text-light border-secondary" placeholder="Filtrar...">
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0 align-middle">
                            <thead class="text-secondary text-uppercase text-xs">
                                <tr>
                                    <th class="ps-4">FR</th>
                                    <th>Marca/Modelo</th>
                                    <th>Estado</th>
                                    <th>Encargado</th>
                                    <th>Fecha</th>
                                    <th class="text-center">D√≠as</th>
                                    <th class="text-end pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tableDiagnosticoOp"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- OPERACIONES: Aprobados / En Servicio -->
        <div class="col-12" id="cardAprobadosOp">
            <div class="card bg-dark-card border-secondary shadow-sm">
                <div
                    class="card-header border-secondary d-flex justify-content-between align-items-center bg-success bg-opacity-10">
                    <h5 class="mb-0 text-success fw-bold"><i class="fas fa-check-circle me-2"></i> Aprobados / En
                        Servicio</h5>
                    <div class="d-flex align-items-center gap-2">
                        <div class="input-group input-group-sm" style="width: 200px;">
                            <input type="text" id="searchAprobadosOp"
                                class="form-control bg-dark text-light border-secondary" placeholder="Filtrar...">
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" id="btnPrevAprobadosOp" disabled><i
                                    class="fas fa-chevron-left"></i></button>
                            <span class="btn btn-outline-secondary disabled text-light border-secondary"
                                id="pageInfoAprobadosOp">1/1</span>
                            <button class="btn btn-outline-secondary" id="btnNextAprobadosOp" disabled><i
                                    class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0 align-middle">
                            <thead class="text-secondary text-uppercase text-xs">
                                <tr>
                                    <th class="ps-4">FR</th>
                                    <th>Marca/Modelo</th>
                                    <th>Estado</th>
                                    <th>Encargado</th>
                                    <th>Fecha</th>
                                    <th class="text-center">D√≠as</th>
                                    <th class="text-end pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tableAprobadosOp"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- RECEPCI√ìN: Servicio Culminado (Listos para Entregar) -->
        <div class="col-12" id="cardCulminadosOp">
            <div class="card bg-dark-card border-secondary shadow-sm">
                <div
                    class="card-header border-secondary d-flex justify-content-between align-items-center bg-primary bg-opacity-10">
                    <h5 class="mb-0 text-primary fw-bold"><i class="fas fa-flag-checkered me-2"></i> Servicio Culminado
                        (Listos para Entregar)</h5>
                    <div class="input-group input-group-sm w-25">
                        <input type="text" id="searchCulminadosOp"
                            class="form-control bg-dark text-light border-secondary" placeholder="Filtrar...">
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0 align-middle">
                            <thead class="text-secondary text-uppercase text-xs">
                                <tr>
                                    <th class="ps-4">FR</th>
                                    <th>Marca/Modelo</th>
                                    <th>Estado</th>
                                    <th>Encargado</th>
                                    <th>Fecha</th>
                                    <th class="text-center">D√≠as</th>
                                    <th class="text-end pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tableCulminadosOp"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ALMAC√âN: Repuestos para Diagn√≥stico -->
        <div class="col-12 d-none" id="cardRepDiag">
            <div class="card bg-dark-card border-secondary shadow-sm">
                <div class="card-header border-secondary bg-warning bg-opacity-10">
                    <h5 class="mb-0 text-warning fw-bold"><i class="fas fa-boxes me-2"></i> Repuestos para Diagn√≥stico
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0 align-middle">
                            <thead class="text-secondary text-uppercase text-xs">
                                <tr>
                                    <th class="ps-4">FR</th>
                                    <th>Marca/Modelo</th>
                                    <th>Estado</th>
                                    <th>Encargado</th>
                                    <th>Fecha</th>
                                    <th class="text-center">D√≠as</th>
                                    <th class="text-end pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tableRepDiag"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ALMAC√âN: Repuestos para Servicio -->
        <div class="col-12 d-none" id="cardRepServ">
            <div class="card bg-dark-card border-secondary shadow-sm">
                <div class="card-header border-secondary bg-info bg-opacity-10">
                    <h5 class="mb-0 text-info fw-bold"><i class="fas fa-cogs me-2"></i> Repuestos para Servicio</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0 align-middle">
                            <thead class="text-secondary text-uppercase text-xs">
                                <tr>
                                    <th class="ps-4">FR</th>
                                    <th>Marca/Modelo</th>
                                    <th>Estado</th>
                                    <th>Encargado</th>
                                    <th>Fecha</th>
                                    <th class="text-center">D√≠as</th>
                                    <th class="text-end pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tableRepServ"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    {% endif %}

    <!-- INFO MODAL -->
    <div class="modal fade" id="detailedInfoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark-card border-secondary text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="fas fa-info-circle text-info me-2"></i>Detalles del Equipo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 border-bottom border-secondary pb-2">
                        <small class="text-secondary text-uppercase d-block">Equipo</small>
                        <h4 id="infoMarca" class="mb-0"></h4>
                        <span id="infoFr" class="badge bg-secondary mt-1"></span>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <small class="text-secondary text-uppercase">Cliente</small>
                            <p id="infoCliente" class="fw-bold text-light mb-0 border-bottom border-dark pb-1"></p>
                        </div>
                        <div class="col-md-6">
                            <small class="text-secondary text-uppercase">Serie</small>
                            <p id="infoSerie" class="fw-bold text-light mb-0 border-bottom border-dark pb-1"></p>
                        </div>

                        <div class="col-md-6">
                            <small class="text-secondary text-uppercase">Fecha Ingreso</small>
                            <p id="infoFecha" class="fw-bold text-light mb-0 border-bottom border-dark pb-1"></p>
                        </div>
                        <div class="col-md-6">
                            <small class="text-secondary text-uppercase">Condici√≥n</small>
                            <p id="infoCondicion" class="fw-bold text-light mb-0 border-bottom border-dark pb-1"></p>
                        </div>

                        <div class="col-md-6">
                            <small class="text-secondary text-uppercase">Encargado Mantenimiento</small>
                            <p id="infoEncargado" class="fw-bold text-light mb-0 border-bottom border-dark pb-1"></p>
                        </div>
                        <div class="col-md-6">
                            <small class="text-secondary text-uppercase">Accesorios</small>
                            <p id="infoAccesorios" class="fw-bold text-light mb-0 border-bottom border-dark pb-1"></p>
                        </div>
                        <div class="col-md-6">
                            <small class="text-secondary text-uppercase text-info">No. Informe</small>
                            <p id="infoInforme" class="fw-bold text-info mb-0 border-bottom border-dark pb-1"></p>
                        </div>
                        <div class="col-12 mt-3">
                            <small class="text-secondary text-uppercase">Estado</small>
                            <div id="infoEstado" class="mt-1"></div>
                        </div>


                        <div class="col-12 mt-3">
                            <small class="text-secondary text-uppercase text-info"><i class="fas fa-file-alt me-1"></i>
                                Reporte Cliente</small>
                            <div class="p-2 bg-dark rounded border border-secondary text-light small" id="infoReporte"
                                style="max-height:100px; overflow-y:auto;"></div>
                        </div>
                        <div class="col-12 mt-2">
                            <small class="text-secondary text-uppercase text-warning"><i
                                    class="fas fa-sticky-note me-1"></i> Observaciones</small>
                            <div class="p-2 bg-dark rounded border border-secondary text-light small mt-1"
                                id="infoObservaciones" style="max-height:100px; overflow-y:auto;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary p-1">
                    <button type="button" class="btn btn-sm btn-secondary w-100" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CREATE EQUIPMENT MODAL -->
<div class="modal fade" id="createEquipmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark-card border-secondary text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-plus-circle text-success me-2"></i>Registrar Nuevo Equipo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createEquipmentForm">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label text-secondary small text-uppercase fw-bold">N√∫mero de FR</label>
                            <input type="text" name="fr" class="form-control bg-dark text-light border-secondary"
                                placeholder="Ej: 100-1">
                        </div>
                        <div class="col-md-8">
                            <label class="form-label text-secondary small text-uppercase fw-bold">Cliente *</label>
                            <input type="text" name="cliente" class="form-control bg-dark text-light border-secondary"
                                required>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label text-secondary small text-uppercase fw-bold">Fecha de
                                Ingreso</label>
                            <input type="date" name="fecha_ingreso"
                                class="form-control bg-dark text-light border-secondary">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-secondary small text-uppercase fw-bold">Marca *</label>
                            <input type="text" name="marca" class="form-control bg-dark text-light border-secondary"
                                required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-secondary small text-uppercase fw-bold">Modelo *</label>
                            <input type="text" name="modelo" class="form-control bg-dark text-light border-secondary"
                                required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label text-secondary small text-uppercase fw-bold">N√∫mero de
                                Serie</label>
                            <input type="text" name="serie" class="form-control bg-dark text-light border-secondary">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary small text-uppercase fw-bold">Accesorios</label>
                            <input type="text" name="accesorios"
                                class="form-control bg-dark text-light border-secondary">
                        </div>

                        <div class="col-12">
                            <label class="form-label text-secondary small text-uppercase fw-bold">Reporte del Cliente
                                *</label>
                            <textarea name="reporte_cliente" class="form-control bg-dark text-light border-secondary"
                                rows="3" required placeholder="Describa el problema o solicitud del cliente"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="submitCreateEquipment()">
                    <i class="fas fa-save me-1"></i> Guardar Equipo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- DATA -->
<div id="equipmentsData" data-equipments='{{ equipments_json|safe }}' data-user-role='{{ current_role|tojson }}'
    style="display:none;"></div>

<div class="row"> <!--
    CARD: HISTORIAL ENTREGADOS (PAGINATED) -->
    <div class="col-12 mt-4" id="cardEntregados">
        <div class="card bg-dark border-secondary shadow-sm h-100">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                <div class="text-white fw-bold"><i class="fas fa-history me-2"></i> HISTORIAL DE ENTREGADOS</div>
                <input type="text" id="searchEntregadosGrouped"
                    class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="Buscar..."
                    style="width: 150px;">
            </div>
            <div class="card-body p-0 table-responsive">
                <table class="table table-dark table-hover mb-0 align-middle">
                    <thead>
                        <tr class="text-secondary text-xs text-uppercase">
                            <th class="ps-4">Equipo</th>
                            <th>Estado</th>
                            <th>Estado</th>
                            <th>Encargado</th>
                            <th>Fecha</th>
                            <th class="text-end pe-4">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="tableEntregadosGrouped">
                        <!-- JS Rendered -->
                    </tbody>
                </table>
            </div>
            <div class="card-footer border-secondary d-flex justify-content-between align-items-center py-2">
                <small class="text-muted" id="infoEntregadosGrouped">0-0/0</small>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" id="btnPrevEntregadosGrouped" disabled><i
                            class="fas fa-chevron-left"></i></button>
                    <button class="btn btn-outline-secondary" id="btnNextEntregadosGrouped" disabled><i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Create Equipment Logic
        window.submitCreateEquipment = async function () {
            const form = document.getElementById('createEquipmentForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/equipment/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Equipo creado correctamente');
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al procesar la solicitud');
            }
        };

        const dataEl = document.getElementById('equipmentsData');
        if (!dataEl) return;

        let equipments = JSON.parse(dataEl.dataset.equipments);
        let userRole = JSON.parse(dataEl.dataset.userRole);
        if (userRole) userRole = userRole.toLowerCase();

        // Helper to normalize strings (remove accents and lowercase)
        const normalize = str => (str || '').normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

        // Helper functions
        function getStatusBadge(status) {
            let badgeClass = 'bg-secondary';
            let icon = 'fa-circle';
            let s = status.toLowerCase();

            if (s.includes('diagnostico') || s.includes('revision') || s.includes('standby')) { badgeClass = 'bg-info text-dark'; icon = 'fa-stethoscope'; }
            else if (s.includes('aprobado')) { badgeClass = 'bg-success'; icon = 'fa-check-circle'; }
            else if (s.includes('espera') || s.includes('pendiente')) { badgeClass = 'bg-warning text-dark'; icon = 'fa-clock'; }
            else if (s.includes('servicio') || s.includes('reparacion')) { badgeClass = 'bg-primary'; icon = 'fa-tools'; }
            else if (s.includes('culminado') || s.includes('entregado')) { badgeClass = 'bg-success'; icon = 'fa-flag-checkered'; }

            return `<span class="badge ${badgeClass} text-uppercase"><i class="fas ${icon} me-1"></i> ${(status || '').toUpperCase()}</span>`;
        }

        function createRow(item, isVisualizador = false) {
            const today = new Date();
            const ingreso = new Date(item.fecha_ingreso);
            const diffDays = Math.ceil(Math.abs(today - ingreso) / (1000 * 60 * 60 * 24));
            const s = normalize(item.estado);

            // Info Button (Universal)
            const infoBtn = `<button class="btn btn-sm btn-outline-info ms-1" onclick="showInfo(${item.id})" title="Ver Detalles"><i class="fas fa-eye"></i></button>`;

            let actionsHtml = '';
            if (!isVisualizador) {
                actionsHtml = `<div class="btn-group">`;
                const role = userRole.toLowerCase();
                const isAdmin = role === 'admin' || role === 'venllas';
                const isOps = role === 'operaciones' || isAdmin;
                const isRec = role === 'recepcion' || isAdmin;
                const isAlm = role === 'almacen' || isAdmin;

                // State Machine Logic
                if (s.includes('espera de diagnostico') || s === 'espera diagnostico') {
                    if (isOps) actionsHtml += `<button class="btn btn-sm btn-info" onclick="startDiagnostics(${item.id}, 'en Diagnostico')">Iniciar Diag</button>`;
                }
                else if (s.includes('diagnostico') && !s.includes('espera')) {
                    if (isOps) {
                        actionsHtml += `<button class="btn btn-sm btn-success" onclick="updateStatus(${item.id}, 'Pendiente de aprobacion')">Terminar Diag</button>`;
                        actionsHtml += `<button class="btn btn-sm btn-warning" onclick="updateStatus(${item.id}, 'espera de repuesto o consumible')">Pedir Repuestos</button>`;
                    }
                }
                else if (s.includes('consumible') || (s.includes('repuesto') && !s.includes('repuestos'))) {
                    if (isAlm) actionsHtml += `<button class="btn btn-sm btn-warning" onclick="updateStatus(${item.id}, 'Repuesto entregado')">Confirmar Llegada</button>`;
                }
                else if (s.includes('repuesto entregado')) {
                    if (isOps) actionsHtml += `<button class="btn btn-sm btn-primary" onclick="updateStatus(${item.id}, 'Pendiente de aprobacion')">Continuar (Fin Diag)</button>`;
                }
                else if (s.includes('pendiente de aprobacion') || s.includes('pendiente aprobacion')) {
                    if (isRec) {
                        actionsHtml += `<button class="btn btn-sm btn-success" onclick="updateStatus(${item.id}, 'Aprobado')">Aprobar</button>`;
                        actionsHtml += `<button class="btn btn-sm btn-danger" onclick="updateStatus(${item.id}, 'Rechazado')">Rechazar</button>`;
                    }
                }
                else if (s === 'aprobado') {
                    if (isOps) actionsHtml += `<button class="btn btn-sm btn-primary" onclick="updateStatus(${item.id}, 'Inicio de Servicio')">Iniciar Mantenimiento</button>`;
                }
                else if (s.includes('inicio de servicio') || s.includes('en servicio')) {
                    if (isOps) {
                        actionsHtml += `<button class="btn btn-sm btn-success" onclick="updateStatus(${item.id}, 'Servicio culminado')">Terminar Mantenimiento</button>`;
                        actionsHtml += `<button class="btn btn-sm btn-warning" onclick="updateStatus(${item.id}, 'espera de repuestos')">Pedir Repuestos</button>`;
                    }
                }
                else if (s.includes('espera de repuestos')) {
                    if (isAlm) actionsHtml += `<button class="btn btn-sm btn-primary" onclick="updateStatus(${item.id}, 'En servicio')">Confirmar Llegada (Serv)</button>`;
                }
                else if (s.includes('servicio culminado')) {
                    if (isRec) actionsHtml += `<button class="btn btn-sm btn-info" onclick="updateStatus(${item.id}, 'Entregado')">Entregar Cliente</button>`;
                }

                if (isAdmin) {
                    actionsHtml += `<button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteEquipment(${item.id})" title="Eliminar"><i class="fas fa-trash"></i></button>`;
                }

                // Add Info Button
                actionsHtml += infoBtn;
                actionsHtml += `</div>`;
            } else {
                // Visualizador Actions (Just Info Button)
                actionsHtml = infoBtn;
            }

            const frDisplay = item.fr || 'Sin FR';

            if (isVisualizador) {
                // Days logic for visualizador: Only for "En Diagnostico"
                let daysCell = '';
                // Check if table is "Diagnostico" type based on state content.
                // We'll trust the caller passes items filtered. 
                // But specifically, user asked for "D√≠as" column only for "En diagn√≥stico".
                // Since this function builds a row, we check the item state.

                // However, we need to know if we should render the TD or not depending on the table header.
                // The table headers are static in HTML. We need to match.
                // 1. Diagnostico Table -> Has "D√≠as"? No, header says specific cols.
                // 2. Approved Table -> No days column requested?

                // Actually, the request says "A√±ade una columna ‚ÄúD√≠as‚Äù ... calcularse √∫nicamente para equipos en estado ‚ÄúEn diagn√≥stico‚Äù."
                // This implies the Diagnostico table needs that column.
                // The generic createRow returns a TR string. formatting must match the TABLE THEAD.

                // Current Table 1 (Diag) Headers: FR, Marca/Modelo, Estado, Encargado, Fecha. (5 cols)
                // We need to ADD "D√≠as" header to table 1 HTML.
                // And for other tables, we shouldn't show it? Or show it but empty?
                // The cleanest way is to just render it for all tables in Visualizador mode, but only populate it for Diag items.
                // BUT, HTML Thead must match.
                // I will add "D√≠as" header to ALL Visualizador tables for consistency, or dynamically.
                // Let's assume I'll update the HTML headers to include "D√≠as" for all 3 tables or just Diag.
                // User said "Esta columna debe calcularse √∫nicamente para equipos en estado ‚ÄúEn diagn√≥stico‚Äù."
                // If I add the column <td> to the row, I must add <th> to the table.

                let daysValue = '-';
                if (s.includes('diagnostico') && !s.includes('espera')) {
                    daysValue = `<span class="badge ${diffDays > 3 ? 'bg-danger' : 'bg-success'}">${diffDays} d√≠as</span>`;
                }

                // Assuming all Visualizador tables will have the 'D√≠as' column added to THEAD
                return `
                <tr>
                    <td class="ps-4 fw-bold text-info">${frDisplay}</td>
                    <td>${item.marca} ${item.modelo}</td>
                    <td>${getStatusBadge(item.estado)}</td>
                    <td class="text-light">${item.encargado}</td>
                    <td class="text-muted">${item.fecha_ingreso || 'N/A'}</td>
                    <td class="text-center">${daysValue}</td> <!-- Days Column -->
                    <td class="text-end pe-4">${actionsHtml}</td> <!-- Actions including Info -->
                </tr>
            `;
            } else {
                return `
                <tr>
                    <td class="ps-4 fw-bold text-info">${frDisplay}</td>
                    <td class="text-white text-uppercase">${item.marca} ${item.modelo}</td>
                    <td>${getStatusBadge(item.estado)}</td>
                    <td class="text-sm text-light"><i class="fas fa-user-circle me-1 text-muted"></i> ${item.encargado}</td>
                    <td class="text-sm text-muted">${item.fecha_ingreso || 'N/A'}</td>
                    <td class="text-center"><span class="badge ${diffDays > 5 ? 'bg-danger' : 'bg-success'} badge-pill">${diffDays} d√≠as</span></td>
                    <td class="text-end pe-4">${actionsHtml}</td>
                </tr>
            `;
            }
        }

        // ... [KPI Logic unchanged] ...
        let countDiag = 0, countPend = 0, countApro = 0, countRev = 0;
        equipments.forEach(item => {
            const s = (item.estado || '').toLowerCase();
            if (s.includes('revision') || s.includes('reevaluacion')) countRev++;
            else if (s.includes('diagnostico')) countDiag++;
            else if (s.includes('pendiente') || s.includes('espera de aprobacion')) countPend++;
            else if ((s.includes('aprobado') || s.includes('servicio') || s.includes('repuesto')) && !s.includes('culminado') && !s.includes('entregado')) countApro++;
        });

        if (document.getElementById('kpiTotal')) document.getElementById('kpiTotal').innerText = equipments.length;
        if (document.getElementById('kpiDiag')) document.getElementById('kpiDiag').innerText = countDiag;
        if (document.getElementById('kpiPend')) document.getElementById('kpiPend').innerText = countPend;
        if (document.getElementById('kpiApro')) document.getElementById('kpiApro').innerText = countApro;


        // --- LOGIC FOR ENTREGADOS TABLE (Universal except Almacen) ---
        const cardEntregados = document.getElementById('cardEntregados');
        const isAlmacenRole = userRole === 'almacen';

        if (isAlmacenRole) {
            if (cardEntregados) cardEntregados.classList.add('d-none');
        } else {
            if (cardEntregados) cardEntregados.classList.remove('d-none');

            const tEntregados = document.getElementById('tableEntregadosGrouped');
            const sEntregados = document.getElementById('searchEntregadosGrouped');
            const btnPrev = document.getElementById('btnPrevEntregadosGrouped');
            const btnNext = document.getElementById('btnNextEntregadosGrouped');
            const infoEnt = document.getElementById('infoEntregadosGrouped');

            let entPage = 1;
            const entLimit = 5;

            // Filter including all variations of "entregado" using normalize
            let entData = equipments.filter(i => normalize(i.estado).includes('entregado'));

            function renderEntregadosSpecial() {
                const term = normalize(sEntregados ? sEntregados.value : '');
                const filtered = entData.filter(item =>
                    normalize(item.fr).includes(term) ||
                    normalize(item.marca).includes(term) ||
                    normalize(item.modelo).includes(term) ||
                    normalize(item.cliente).includes(term)
                );

                const totalPages = Math.ceil(filtered.length / entLimit) || 1;
                if (entPage > totalPages) entPage = 1;

                const start = (entPage - 1) * entLimit;
                const end = start + entLimit;
                const pageData = filtered.slice(start, end);

                if (tEntregados) {
                    tEntregados.innerHTML = pageData.length ? pageData.map(i => createRow(i, true)).join('')
                        : '<tr><td colspan="6" class="text-center text-muted py-3">Sin equipos entregados</td></tr>';
                }

                if (infoEnt) infoEnt.innerText = `${entPage}/${totalPages}`;
                if (btnPrev) btnPrev.disabled = (entPage === 1);
                if (btnNext) btnNext.disabled = (entPage === totalPages);
            }

            if (sEntregados) sEntregados.addEventListener('input', () => { entPage = 1; renderEntregadosSpecial(); });
            if (btnPrev) btnPrev.onclick = () => { if (entPage > 1) { entPage--; renderEntregadosSpecial(); } };
            if (btnNext) btnNext.onclick = () => {
                const term = normalize(sEntregados ? sEntregados.value : '');
                const filtered = entData.filter(item => normalize(item.fr).includes(term) || normalize(item.marca).includes(term));
                if (entPage < Math.ceil(filtered.length / entLimit)) { entPage++; renderEntregadosSpecial(); }
            };
            renderEntregadosSpecial();
        }

        // --- ROLE-BASED VIEW LOGIC ---
        if (userRole === 'visualizador' || userRole === 'admin') {
            const ITEMS_PER_PAGE = 5;

            function createRenderLogic(filterFn, tableId, searchId, paginationIds = null) {
                let sectionData = equipments.filter(item => filterFn(normalize(item.estado)));
                const searchInput = document.getElementById(searchId);
                let currentTerm = '';
                let pageState = { page: 1 };

                function render() {
                    let filtered = sectionData.filter(item =>
                        normalize(item.fr).includes(currentTerm) ||
                        normalize(item.marca).includes(currentTerm) ||
                        normalize(item.modelo).includes(currentTerm)
                    );

                    if (paginationIds) {
                        const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE) || 1;
                        if (pageState.page > totalPages) pageState.page = 1;
                        const start = (pageState.page - 1) * ITEMS_PER_PAGE;
                        const pageData = filtered.slice(start, start + ITEMS_PER_PAGE);
                        document.getElementById(tableId).innerHTML = pageData.length ? pageData.map(i => createRow(i, userRole === 'visualizador')).join('')
                            : `<tr><td colspan="7" class="text-center text-muted py-3">Sin resultados</td></tr>`;
                        document.getElementById(paginationIds.info).innerText = `${pageState.page}/${totalPages}`;
                        document.getElementById(paginationIds.prev).disabled = (pageState.page === 1);
                        document.getElementById(paginationIds.next).disabled = (pageState.page === totalPages);
                    } else {
                        document.getElementById(tableId).innerHTML = filtered.length ? filtered.map(i => createRow(i, userRole === 'visualizador')).join('')
                            : `<tr><td colspan="7" class="text-center text-muted py-3">Sin resultados</td></tr>`;
                    }
                }

                if (searchInput) searchInput.addEventListener('input', (e) => { currentTerm = normalize(e.target.value); pageState.page = 1; render(); });
                if (paginationIds) {
                    document.getElementById(paginationIds.prev).addEventListener('click', () => { if (pageState.page > 1) { pageState.page--; render(); } });
                    document.getElementById(paginationIds.next).addEventListener('click', () => {
                        const filtered = sectionData.filter(i => normalize(i.fr).includes(currentTerm) || normalize(i.marca).includes(currentTerm));
                        if (pageState.page < Math.ceil(filtered.length / ITEMS_PER_PAGE)) { pageState.page++; render(); }
                    });
                }
                render();
            }

            createRenderLogic(s => (s.includes('diagnostico') && !s.includes('revision')) || s.includes('consumible') || (s.includes('repuesto') && !s.includes('repuestos')), 'tableDiagnostico', 'searchDiagnostico');
            createRenderLogic(s => (s.includes('aprobado') || s.includes('servicio') || s.includes('repuestos')) && !s.includes('entregado') && !s.includes('culminado'), 'tableAprobado', 'searchAprobado', { prev: 'btnPrevAprobado', next: 'btnNextAprobado', info: 'pageInfoAprobado' });
            createRenderLogic(s => s.includes('revision') || s.includes('reevaluacion'), 'tableRevision', 'searchRevision');
            createRenderLogic(s => s.includes('pendiente') || s.includes('espera de aprobacion'), 'tablePendiente', 'searchPendiente', { prev: 'btnPrevPendiente', next: 'btnNextPendiente', info: 'pageInfoPendiente' });

        } else {
            // OPERATIONAL VIEW LOGIC (Individual tables with search/pagination like visualizador)
            const ITEMS_PER_PAGE = 5;

            // Hide/show cards based on role
            if (isAlmacenRole) {
                document.getElementById('cardPendientesOp').classList.add('d-none');
                document.getElementById('cardDiagnosticoOp').classList.add('d-none');
                document.getElementById('cardAprobadosOp').classList.add('d-none');
                document.getElementById('cardCulminadosOp').classList.add('d-none');
                document.getElementById('cardRepDiag').classList.remove('d-none');
                document.getElementById('cardRepServ').classList.remove('d-none');
            } else {
                document.getElementById('cardPendientesOp').classList.remove('d-none');
                document.getElementById('cardDiagnosticoOp').classList.remove('d-none');
                document.getElementById('cardAprobadosOp').classList.remove('d-none');
                document.getElementById('cardCulminadosOp').classList.remove('d-none');
            }

            // Reusable render logic function (same as visualizador)
            function createRenderLogicOp(filterFn, tableId, searchId, paginationIds = null) {
                let sectionData = equipments.filter(item => filterFn(normalize(item.estado)));
                const searchInput = document.getElementById(searchId);
                let currentTerm = '';
                let pageState = { page: 1 };

                function render() {
                    let filtered = sectionData.filter(item =>
                        normalize(item.fr).includes(currentTerm) ||
                        normalize(item.marca).includes(currentTerm) ||
                        normalize(item.modelo).includes(currentTerm)
                    );

                    if (paginationIds) {
                        const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE) || 1;
                        if (pageState.page > totalPages) pageState.page = 1;
                        const start = (pageState.page - 1) * ITEMS_PER_PAGE;
                        const pageData = filtered.slice(start, start + ITEMS_PER_PAGE);
                        document.getElementById(tableId).innerHTML = pageData.length ? pageData.map(i => createRow(i, userRole === 'visualizador')).join('')
                            : `<tr><td colspan="7" class="text-center text-muted py-3">Sin resultados</td></tr>`;
                        document.getElementById(paginationIds.info).innerText = `${pageState.page}/${totalPages}`;
                        document.getElementById(paginationIds.prev).disabled = (pageState.page === 1);
                        document.getElementById(paginationIds.next).disabled = (pageState.page === totalPages);
                    } else {
                        document.getElementById(tableId).innerHTML = filtered.length ? filtered.map(i => createRow(i, userRole === 'visualizador')).join('')
                            : `<tr><td colspan="7" class="text-center text-muted py-3">Sin resultados</td></tr>`;
                    }
                }

                if (searchInput) searchInput.addEventListener('input', (e) => { currentTerm = normalize(e.target.value); pageState.page = 1; render(); });
                if (paginationIds) {
                    document.getElementById(paginationIds.prev).addEventListener('click', () => { if (pageState.page > 1) { pageState.page--; render(); } });
                    document.getElementById(paginationIds.next).addEventListener('click', () => {
                        const filtered = sectionData.filter(i => normalize(i.fr).includes(currentTerm) || normalize(i.marca).includes(currentTerm));
                        if (pageState.page < Math.ceil(filtered.length / ITEMS_PER_PAGE)) { pageState.page++; render(); }
                    });
                }
                render();
            }

            // RECEPCI√ìN & OPERACIONES: Pendientes de Aprobaci√≥n (paginated)
            createRenderLogicOp(
                s => s.includes('pendiente') && s.includes('aprobacion'),
                'tablePendientesOp',
                'searchPendientesOp',
                { prev: 'btnPrevPendientesOp', next: 'btnNextPendientesOp', info: 'pageInfoPendientesOp' }
            );

            // OPERACIONES: En Diagn√≥stico (with search)
            createRenderLogicOp(
                s => (s.includes('diagnostico') && !s.includes('revision')) || s.includes('consumible') || s.includes('repuesto entregado'),
                'tableDiagnosticoOp',
                'searchDiagnosticoOp'
            );

            // OPERACIONES: Aprobados / En Servicio (paginated)
            createRenderLogicOp(
                s => (s.includes('aprobado') || s.includes('servicio') || s.includes('repuestos')) && !s.includes('culminado') && !s.includes('entregado'),
                'tableAprobadosOp',
                'searchAprobadosOp',
                { prev: 'btnPrevAprobadosOp', next: 'btnNextAprobadosOp', info: 'pageInfoAprobadosOp' }
            );

            // RECEPCI√ìN: Servicio Culminado (listos para entregar)
            createRenderLogicOp(
                s => s.includes('culminado'),
                'tableCulminadosOp',
                'searchCulminadosOp'
            );

            // ALMAC√âN: Repuestos para Diagn√≥stico
            if (isAlmacenRole) {
                createRenderLogicOp(
                    s => s.includes('repuesto') && s.includes('consumible'),
                    'tableRepDiag',
                    null
                );

                // ALMAC√âN: Repuestos para Servicio
                createRenderLogicOp(
                    s => s.includes('espera') && s.includes('repuestos'),
                    'tableRepServ',
                    null
                );
            }
        }

        // Global Action wrappers
        window.startDiagnostics = function (id, status) {
            const encargado = prompt("ASIGNACI√ìN DE T√âCNICO:\nPor favor, ingrese el nombre del encargado:");
            if (encargado === null) return;
            if (!encargado.trim()) { alert("Debe asignar un encargado."); return; }
            updateStatus(id, status, encargado.trim());
        };

        window.updateStatus = async function (id, newStatus, newEncargado = null) {
            let msg = `¬øCambiar estado a: ${newStatus}?`;
            if (newEncargado) msg += `\nAsignando a: ${newEncargado}`;
            if (!confirm(msg)) return;

            const formData = new FormData();
            formData.append('status', newStatus);
            if (newEncargado) formData.append('encargado', newEncargado);

            // Use legacy endpoint which now validates workflow
            try {
                const response = await fetch(`/api/equipment/${id}/update_status`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) location.reload();
                else alert('Error: ' + data.error);
            } catch (err) {
                alert('Error de red: ' + err);
            }
        };

        window.deleteEquipment = function (id) {
            if (!confirm('¬øEST√Å SEGURO DE ELIMINAR ESTE EQUIPO?')) return;
            fetch(`/api/equipment/${id}/delete`, { method: 'POST' })
                .then(r => r.json()).then(d => { if (d.success) location.reload(); else alert(d.error); });
        };

        // Show Info Modal Logic
        window.showInfo = function (id) {
            // Find item
            const item = equipments.find(e => e.id === id);
            if (!item) return;

            // Populate Modal
            document.getElementById('infoFr').innerText = item.fr || 'N/A';
            document.getElementById('infoMarca').innerText = `${item.marca} ${item.modelo}`;
            document.getElementById('infoEstado').innerHTML = getStatusBadge(item.estado);
            document.getElementById('infoEncargado').innerText = item.encargado || 'No Asignado';
            document.getElementById('infoFecha').innerText = item.fecha_ingreso || 'N/A';
            document.getElementById('infoReporte').innerText = item.reporte_cliente || 'Sin reporte';

            // New Fields
            if (document.getElementById('infoCliente')) document.getElementById('infoCliente').innerText = item.cliente || 'N/A';
            if (document.getElementById('infoSerie')) document.getElementById('infoSerie').innerText = item.serie || 'N/A';
            if (document.getElementById('infoCondicion')) document.getElementById('infoCondicion').innerText = item.condicion || 'Regular';
            if (document.getElementById('infoAccesorios')) document.getElementById('infoAccesorios').innerText = item.accesorios || 'Ninguno';
            if (document.getElementById('infoInforme')) document.getElementById('infoInforme').innerText = item.numero_informe || 'N/A';
            if (document.getElementById('infoObservaciones')) document.getElementById('infoObservaciones').innerText = item.observaciones || 'Sin observaciones';

            const myModal = new bootstrap.Modal(document.getElementById('detailedInfoModal'));
            myModal.show();
        };
    });
</script>

<style>
    .bg-dark-card {
        background-color: #1e1e2f;
    }

    .card-header {
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .icon-shape {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.75rem;
    }

    /* Compact badges for status labels */
    .badge {
        padding: 0.25rem 0.5rem !important;
        line-height: 1.2;
    }
</style>

<!-- Workflow Management Script -->
<script src="{{ url_for('static', filename='js/workflow.js') }}"></script>

{% endblock %}